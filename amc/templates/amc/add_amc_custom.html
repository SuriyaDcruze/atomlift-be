{% extends "wagtailadmin/base.html" %}
{% load static %}

{% block extra_css %}
<style>

  .w-tabs {
    background: white;
    border: 1px solid var(--w-color-border);
    border-radius: 4px;
    margin-bottom: 2rem;
  }

  .w-tabs__list {
    display: flex;
    border-bottom: 1px solid var(--w-color-border);
    padding: 0;
    margin: 0;
    list-style: none;
    overflow-x: auto;
  }

  .w-tabs__tab {
    padding: 1rem 1.5rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    font-weight: 500;
    color: var(--w-color-text-meta);
  }

  .w-tabs__tab:hover {
    color: var(--w-color-primary);
    background: #f9f9f9;
  }

  .w-tabs__tab.active {
    color: var(--w-color-primary);
    border-bottom-color: var(--w-color-primary);
    background: white;
  }

  .w-tabs__content {
    padding: 2rem;
  }

  .w-panel {
    display: none;
  }

  .w-panel.active {
    display: block;
  }

  .w-field {
    margin-bottom: 1.5rem;
  }

  .w-field__label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--w-color-text);
    font-size: 0.875rem;
  }

  .w-field__required {
    color: var(--w-color-error);
    margin-left: 0.25rem;
  }

  .w-field__input,
  .w-field__select,
  .w-field__textarea {
    width: 100%;
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--w-color-input-border);
    border-radius: 3px;
    font-size: 0.875rem;
    transition: border-color 0.2s;
    font-family: inherit;
  }

  .w-field__input:focus,
  .w-field__select:focus,
  .w-field__textarea:focus {
    outline: none;
    border-color: var(--w-color-input-focus);
    box-shadow: 0 0 0 3px rgba(0, 125, 126, 0.1);
  }

  .w-field__input[readonly] {
    background-color: #f9f9f9;
    color: var(--w-color-text-meta);
  }

  .w-field__help {
    font-size: 0.75rem;
    color: var(--w-color-text-meta);
    margin-top: 0.25rem;
  }

  .w-field__checkbox-wrapper {
    display: flex;
    align-items: center;
  }

  .w-field__checkbox {
    width: auto;
    margin-right: 0.5rem;
  }

  .w-field__addon {
    display: flex;
    gap: 0.5rem;
  }

  .w-field__addon .w-field__select {
    flex: 1;
  }

  .w-button {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 3px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }

  .w-button--primary {
    background: var(--w-color-primary);
    color: white;
  }

  .w-button--primary:hover {
    background: #006464;
  }

  .w-button--secondary {
    background: white;
    color: var(--w-color-text);
    border: 1px solid var(--w-color-border);
  }

  .w-button--secondary:hover {
    background: #f9f9f9;
  }

  .w-button--icon {
    padding: 0.625rem 0.875rem;
    min-width: auto;
  }

  .w-header {
    background: white;
    border-bottom: 1px solid var(--w-color-border);
    padding: 1.5rem 2rem;
    margin: -2rem -2rem 2rem -2rem;
  }

  .w-header__row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .w-header__title {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
    color: var(--w-color-text);
  }

  .w-header__actions {
    display: flex;
    gap: 0.75rem;
  }

  .w-message {
    padding: 1rem 1.25rem;
    border-radius: 3px;
    margin-bottom: 1.5rem;
    border-left: 4px solid;
  }

  .w-message--info {
    background: #e7f3ff;
    border-color: var(--w-color-info);
    color: var(--w-color-info);
  }

  .w-message--success {
    background: #e5f7f1;
    border-color: var(--w-color-success);
    color: var(--w-color-success);
  }

  .w-message--error {
    background: #fef2f2;
    border-color: var(--w-color-error);
    color: var(--w-color-error);
  }

  .w-message__title {
    font-weight: 600;
    margin: 0 0 0.25rem 0;
  }

  .w-message__content {
    margin: 0;
  }

  .w-footer-actions {
    background: white;
    border-top: 1px solid var(--w-color-border);
    padding: 1.5rem 2rem;
    margin: 2rem -2rem -2rem -2rem;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    position: sticky;
    bottom: 0;
  }

  .w-section {
    margin-bottom: 2rem;
  }

  .w-section__heading {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1.25rem 0;
    color: var(--w-color-text);
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--w-color-border);
  }

  .w-field-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .w-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .w-modal.active {
    display: flex;
  }

  .w-modal__dialog {
    background: white;
    border-radius: 4px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .w-modal__header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--w-color-border);
  }

  .w-modal__title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .w-modal__body {
    padding: 1.5rem;
    overflow-y: auto;
  }

  .w-modal__footer {
    padding: 1.5rem;
    border-top: 1px solid var(--w-color-border);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .w-option-list {
    margin-top: 1.5rem;
  }

  .w-option-list__title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0 0 0.75rem 0;
    color: var(--w-color-text-meta);
  }

  .w-option-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid var(--w-color-border);
    border-radius: 3px;
    margin-bottom: 0.5rem;
  }

  .w-option-item__actions {
    display: flex;
    gap: 0.5rem;
  }

  .w-button--small {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  .w-button--danger {
    background: var(--w-color-error);
    color: white;
  }

  .w-button--danger:hover {
    background: #b12226;
  }

  @media (max-width: 768px) {
    .w-header {
      padding: 1rem 1.5rem;
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    }

    .w-header__row {
      flex-direction: column;
      align-items: flex-start;
    }

    .w-header__title {
      font-size: 1.5rem;
    }

    .w-tabs__content {
      padding: 1.5rem;
    }

    .w-field-group {
      grid-template-columns: 1fr;
    }

    .w-footer-actions {
      padding: 1rem 1.5rem;
      margin: 1.5rem -1.5rem -1.5rem -1.5rem;
      flex-direction: column-reverse;
    }

    .w-footer-actions .w-button {
      width: 100%;
      text-align: center;
    }

    .w-tabs__tab {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
    }
  }

  @media (max-width: 480px) {
    .w-header__title {
      font-size: 1.25rem;
    }

    .w-modal__dialog {
      width: 95%;
    }
  }

  .w-content-wrapper {
    background: #f5f5f5;
    min-height: calc(100vh - 4rem);
    padding: 2rem;
  }

  @media (max-width: 768px) {
    .w-content-wrapper {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="w-content-wrapper">
  <div class="w-header">
    <div class="w-header__row">
      <h1 class="w-header__title">
        {% if is_edit %}Edit AMC{% else %}Create AMC{% endif %}
      </h1>
      <div class="w-header__actions">
        <a href="/admin/snippets/amc/amc/" class="w-button w-button--secondary">Cancel</a>
      </div>
    </div>
  </div>

  {% if customer_id_param and selected_customer %}
  <div class="w-message w-message--info">
    <p class="w-message__title">Lift Information</p>
    <p class="w-message__content">If you haven't added Lifts, <a href="/dashboard/customers" target="_blank">click here</a> to add one. After adding, click to refresh.</p>
  </div>
  {% endif %}

  <form id="amcForm">
    <div class="w-tabs">
      <ul class="w-tabs__list" role="tablist">
        <li class="w-tabs__tab active" data-tab="basic" role="tab">Basic Details</li>
        <li class="w-tabs__tab" data-tab="schedule" role="tab">Schedule & Location</li>
        <li class="w-tabs__tab" data-tab="contract" role="tab">Contract & Pricing</li>
      </ul>

      <div class="w-tabs__content">
        <!-- Basic Details Panel -->
        <div class="w-panel active" id="basic-panel">
          <div class="w-section">
            <h2 class="w-section__heading">Basic Information</h2>

            <div class="w-field">
              <label for="customer" class="w-field__label">
                Customer<span class="w-field__required">*</span>
              </label>
              <select id="customer" name="customer" class="w-field__select" required onchange="fetchCustomerDetails()">
                <option value="">Select Customer</option>
                {% for customer in customers %}
                  <option value="{{ customer.id }}"
                          data-job-no="{{ customer.job_no|default:'' }}"
                          data-site-address="{{ customer.site_address|default:''|escapejs }}"
                          {% if selected_customer and selected_customer.id == customer.id %}selected{% endif %}
                          {% if is_edit and amc.customer.id == customer.id %}selected{% endif %}>
                    {{ customer.site_name }}
                    {% if customer.job_no %} ({{ customer.job_no }}){% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="w-field-group">
              <div class="w-field">
                <label for="reference_id" class="w-field__label">Reference ID</label>
                <input type="text" id="reference_id" name="reference_id" 
                       value="{% if is_edit %}{{ amc.reference_id|default:'' }}{% endif %}"
                       class="w-field__input" readonly />
                <p class="w-field__help">Auto-generated reference number</p>
              </div>

              <div class="w-field">
                <label for="amcname" class="w-field__label">AMC Pack Name</label>
                <input type="text" id="amcname" name="amcname" 
                       value="{% if is_edit %}{{ amc.amcname }}{% endif %}"
                       class="w-field__input" />
              </div>
            </div>

            <div class="w-field-group">
              <div class="w-field">
                <label for="invoice_frequency" class="w-field__label">Invoice Frequency</label>
                <select id="invoice_frequency" name="invoice_frequency" class="w-field__select">
                  <option value="annually" {% if not is_edit or amc.invoice_frequency == 'annually' %}selected{% endif %}>Annually</option>
                  <option value="semi_annually" {% if is_edit and amc.invoice_frequency == 'semi_annually' %}selected{% endif %}>Semi Annually</option>
                  <option value="quarterly" {% if is_edit and amc.invoice_frequency == 'quarterly' %}selected{% endif %}>Quarterly</option>
                  <option value="monthly" {% if is_edit and amc.invoice_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                  <option value="per_service" {% if is_edit and amc.invoice_frequency == 'per_service' %}selected{% endif %}>Per Service</option>
                </select>
              </div>

              <div class="w-field">
                <label for="amc_type" class="w-field__label">AMC Type</label>
                <div class="w-field__addon">
                  <select id="amc_type" name="amc_type" class="w-field__select">
                    <option value="">Select AMC Type</option>
                    {% for type in amc_types %}
                      <option value="{{ type.id }}" {% if is_edit and amc.amc_type.id == type.id %}selected{% endif %}>
                        {{ type.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <button type="button" class="w-button w-button--secondary w-button--icon" onclick="openModal('amc-type')">+</button>
                </div>
              </div>
            </div>

            <div class="w-field">
              <label for="payment_terms" class="w-field__label">Payment Terms</label>
              <div class="w-field__addon">
                <select id="payment_terms" name="payment_terms" class="w-field__select">
                  <option value="">Select Payment Terms</option>
                  {% for term in payment_terms %}
                    <option value="{{ term.id }}" {% if is_edit and amc.payment_terms.id == term.id %}selected{% endif %}>
                      {{ term.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="button" class="w-button w-button--secondary w-button--icon" onclick="openModal('payment-terms')">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule & Location Panel -->
        <div class="w-panel" id="schedule-panel">
          <div class="w-section">
            <h2 class="w-section__heading">Schedule Information</h2>

            <div class="w-field-group">
              <div class="w-field">
                <label for="start_date" class="w-field__label">
                  Start Date<span class="w-field__required">*</span>
                </label>
                <input type="date" id="start_date" name="start_date" 
                       value="{% if is_edit %}{{ amc.start_date|date:'Y-m-d' }}{% endif %}"
                       class="w-field__input" required onchange="setEndDate()" />
              </div>

              <div class="w-field">
                <label for="end_date" class="w-field__label">
                  End Date<span class="w-field__required">*</span>
                </label>
                <input type="date" id="end_date" name="end_date" 
                       value="{% if is_edit %}{{ amc.end_date|date:'Y-m-d' }}{% endif %}"
                       class="w-field__input" required />
              </div>
            </div>

            <h2 class="w-section__heading">Location Details</h2>

            <div class="w-field-group">
              <div class="w-field">
                <label for="equipment_no" class="w-field__label">Equipment No</label>
                <input type="text" id="equipment_no" name="equipment_no" 
                       value="{% if is_edit %}{{ amc.equipment_no }}{% endif %}"
                       class="w-field__input" />
              </div>

              <div class="w-field">
                <label for="latitude" class="w-field__label">Latitude</label>
                <input type="text" id="latitude" name="latitude" 
                       value="{% if is_edit %}{{ amc.latitude }}{% endif %}"
                       class="w-field__input" />
              </div>
            </div>

            <div class="w-field">
              <label for="notes" class="w-field__label">Notes</label>
              <textarea id="notes" name="notes" rows="4" class="w-field__textarea">{% if is_edit %}{{ amc.notes }}{% endif %}</textarea>
              <p class="w-field__help">Add any additional notes or comments</p>
            </div>
          </div>
        </div>

        <!-- Contract & Pricing Panel -->
        <div class="w-panel" id="contract-panel">
          <div class="w-section">
            <h2 class="w-section__heading">Contract Settings</h2>

            <div class="w-field">
              <div class="w-field__checkbox-wrapper">
                <input type="checkbox" id="is_generate_contract" name="is_generate_contract" 
                       {% if is_edit and amc.is_generate_contract %}checked{% endif %}
                       onchange="toggleContractFields()" class="w-field__checkbox" />
                <label for="is_generate_contract" class="w-field__label" style="margin-bottom: 0;">Generate Contract Now</label>
              </div>
              <p class="w-field__help">Enable this to create a contract with pricing details</p>
            </div>

            <div id="contractFields" style="display: {% if is_edit and amc.is_generate_contract %}block{% else %}none{% endif %};">
              <h2 class="w-section__heading">Contract Details</h2>

              <div class="w-field-group">
                <div class="w-field">
                  <label for="no_of_services" class="w-field__label">Number of Services</label>
                  <input type="number" id="no_of_services" name="no_of_services" 
                         value="{% if is_edit %}{{ amc.no_of_services|default:'12' }}{% endif %}"
                         class="w-field__input" />
                </div>

                <div class="w-field">
                  <label for="amc_service_item" class="w-field__label">AMC Service Item</label>
                  <select id="amc_service_item" name="amc_service_item" class="w-field__select">
                    <option value="">Select Item</option>
                    {% for item in items %}
                      <option value="{{ item.id }}" {% if is_edit and amc.amc_service_item.id == item.id %}selected{% endif %}>
                        {{ item.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <h2 class="w-section__heading">Pricing</h2>

              <div class="w-field-group">
                <div class="w-field">
                  <label for="price" class="w-field__label">Price per Unit</label>
                  <input type="number" id="price" name="price" 
                         value="{% if is_edit %}{{ amc.price|default:'0.00' }}{% endif %}"
                         class="w-field__input" step="0.01" onchange="calculateTotal()" />
                </div>

                <div class="w-field">
                  <label for="no_of_lifts" class="w-field__label">Number of Lifts</label>
                  <input type="number" id="no_of_lifts" name="no_of_lifts" 
                         value="{% if is_edit %}{{ amc.no_of_lifts|default:'0' }}{% endif %}"
                         class="w-field__input" onchange="calculateTotal()" />
                </div>

                <div class="w-field">
                  <label for="gst_percentage" class="w-field__label">GST Percentage</label>
                  <input type="number" id="gst_percentage" name="gst_percentage" 
                         value="{% if is_edit %}{{ amc.gst_percentage|default:'0.00' }}{% endif %}"
                         class="w-field__input" step="0.01" onchange="calculateTotal()" />
                </div>
              </div>

              <div class="w-field-group">
                <div class="w-field">
                  <label for="total" class="w-field__label">Total</label>
                  <input type="number" id="total" name="total" 
                         value="{% if is_edit %}{{ amc.total|default:'0.00' }}{% endif %}"
                         class="w-field__input" readonly step="0.01" />
                </div>

                <div class="w-field">
                  <label for="contract_amount" class="w-field__label">Contract Amount</label>
                  <input type="number" id="contract_amount" name="contract_amount" 
                         value="{% if is_edit %}{{ amc.contract_amount|default:'0.00' }}{% endif %}"
                         class="w-field__input" readonly step="0.01" />
                </div>

                <div class="w-field">
                  <label for="total_amount_paid" class="w-field__label">Total Amount Paid</label>
                  <input type="number" id="total_amount_paid" name="total_amount_paid" 
                         value="{% if is_edit %}{{ amc.total_amount_paid|default:'0.00' }}{% endif %}"
                         class="w-field__input" step="0.01" min="0" />
                </div>
              </div>
            </div>

            <h2 class="w-section__heading">Status Information</h2>

            <div class="w-field-group">
              <div class="w-field">
                <label for="status" class="w-field__label">Status</label>
                <input type="text" id="status" name="status" 
                       value="{% if is_edit %}{{ amc.status }}{% endif %}"
                       class="w-field__input" readonly />
              </div>

              <div class="w-field">
                <label for="created" class="w-field__label">Created</label>
                <input type="text" id="created" name="created" 
                       value="{% if is_edit %}{{ amc.created|date:'Y-m-d H:i' }}{% endif %}"
                       class="w-field__input" readonly />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="w-footer-actions">
      <a href="/admin/snippets/amc/amc/" class="w-button w-button--secondary">Cancel</a>
      <button type="submit" class="w-button w-button--primary">
        {% if is_edit %}Update AMC{% else %}Create AMC{% endif %}
      </button>
    </div>
  </form>
</div>

<!-- Modal for adding new options -->
<div id="optionModal" class="w-modal">
  <div class="w-modal__dialog">
    <div class="w-modal__header">
      <h3 class="w-modal__title" id="modalTitle">Add New Option</h3>
    </div>
    <div class="w-modal__body">
      <div class="w-field">
        <label for="modalInput" class="w-field__label">Name</label>
        <input type="text" id="modalInput" class="w-field__input" placeholder="Enter value" />
      </div>
      <div class="w-option-list" id="existingOptions"></div>
    </div>
    <div class="w-modal__footer">
      <button type="button" class="w-button w-button--secondary" onclick="closeModal()">Cancel</button>
      <button type="button" class="w-button w-button--primary" onclick="saveOption()">Save</button>
    </div>
  </div>
</div>

<script>
let currentModalType = '';
{% if is_edit %}
const isEditAMC = true;
const submitAMCUrl = "{% url 'edit_amc_custom' amc.id %}";
{% else %}
const isEditAMC = false;
const submitAMCUrl = "{% url 'add_amc_custom' %}";
{% endif %}
const adminHomeUrlAMC = "{% url 'wagtailadmin_home' %}";

// Tab functionality
document.querySelectorAll('.w-tabs__tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const targetTab = this.dataset.tab;
    
    document.querySelectorAll('.w-tabs__tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.w-panel').forEach(p => p.classList.remove('active'));
    
    this.classList.add('active');
    document.getElementById(targetTab + '-panel').classList.add('active');
  });
});

function fetchCustomerDetails() {
  const customerSelect = document.getElementById('customer');
  const selectedOption = customerSelect.options[customerSelect.selectedIndex];

  if (selectedOption.value) {
    const jobNo = selectedOption.getAttribute('data-job-no');
    const siteAddress = selectedOption.getAttribute('data-site-address');

    console.log('Selected customer data:', { jobNo, siteAddress });

    const equipmentNoInput = document.getElementById('equipment_no');
    if (jobNo && equipmentNoInput.value === '') {
      equipmentNoInput.value = jobNo;
      showMessage('success', `Equipment number auto-populated with job number: ${jobNo}`);
    }

    const latitudeInput = document.getElementById('latitude');
    if (siteAddress && siteAddress.trim() !== '') {
      latitudeInput.value = siteAddress;
      showMessage('info', `Site Address populated: ${siteAddress}`);
    }
  }
}

function setEndDate() {
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');

  if (startDateInput.value) {
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(startDate);
    endDate.setFullYear(endDate.getFullYear() + 1);

    endDateInput.value = endDate.toISOString().split('T')[0];
  }
}

function calculateTotal() {
  const price = parseFloat(document.getElementById('price').value) || 0;
  const lifts = parseInt(document.getElementById('no_of_lifts').value) || 0;
  const gst = parseFloat(document.getElementById('gst_percentage').value) || 0;

  const calculatedTotal = price * lifts * (1 + gst / 100);
  document.getElementById('total').value = calculatedTotal.toFixed(2);
  document.getElementById('contract_amount').value = calculatedTotal.toFixed(2);
}

function toggleContractFields() {
  const isChecked = document.getElementById('is_generate_contract').checked;
  const contractFields = document.getElementById('contractFields');
  const amcServiceItem = document.getElementById('amc_service_item');

  if (isChecked) {
    contractFields.style.display = 'block';
    amcServiceItem.setAttribute('required', 'required');
  } else {
    contractFields.style.display = 'none';
    amcServiceItem.removeAttribute('required');
  }
}

function openModal(type) {
  currentModalType = type;
  const modal = document.getElementById('optionModal');
  const modalTitle = document.getElementById('modalTitle');

  modalTitle.textContent = `Add New ${type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;

  loadExistingOptions(type);
  modal.classList.add('active');
}

function closeModal() {
  document.getElementById('optionModal').classList.remove('active');
  document.getElementById('modalInput').value = '';
}

function loadExistingOptions(type) {
  let apiUrl = '';
  if (type === 'amc-type') {
    apiUrl = '/api/amc/amc-types/';
  } else if (type === 'payment-terms') {
    apiUrl = '/api/amc/payment-terms/';
  }

  fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('existingOptions');
      container.innerHTML = `<h4 class="w-option-list__title">Existing ${type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}s</h4>` +
        data.map(item => `
          <div class="w-option-item">
            <span>${item.name}</span>
            <div class="w-option-item__actions">
              <button type="button" class="w-button w-button--small w-button--secondary" onclick="editOption('${type}', ${item.id}, '${item.name}')">Edit</button>
              <button type="button" class="w-button w-button--small w-button--danger" onclick="deleteOption('${type}', ${item.id})">Delete</button>
            </div>
          </div>
        `).join('');
    });
}

function saveOption() {
  const value = document.getElementById('modalInput').value.trim();
  if (!value) return;

  let apiUrl = '';
  const data = {};
  if (currentModalType === 'amc-type') {
    apiUrl = '/api/amc/amc-types/';
    data.name = value;
  } else if (currentModalType === 'payment-terms') {
    apiUrl = '/api/amc/payment-terms/';
    data.name = value;
  }

  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById(currentModalType.split('-').join('_'));
      const option = new Option(value, data.id);
      select.appendChild(option);
      select.value = data.id;

      closeModal();
      showMessage('success', `${currentModalType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} added successfully`);
    } else {
      showMessage('error', data.error);
    }
  });
}

function editOption(type, id, currentValue) {
  const newValue = prompt(`Edit ${type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}:`, currentValue);
  if (newValue && newValue.trim() && newValue !== currentValue) {
    let apiUrl = '';
    if (type === 'amc-type') {
      apiUrl = `/api/amc/amc-types/${id}/`;
    } else if (type === 'payment-terms') {
      apiUrl = `/api/amc/payment-terms/${id}/`;
    }

    fetch(apiUrl, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ name: newValue.trim() })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        loadExistingOptions(type);
        const select = document.getElementById(type.split('-').join('_'));
        const option = select.querySelector(`option[value="${id}"]`);
        if (option) {
          option.textContent = newValue.trim();
        }
        showMessage('success', `${type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} updated successfully`);
      } else {
        showMessage('error', data.error);
      }
    });
  }
}

function deleteOption(type, id) {
  if (!confirm(`Are you sure you want to delete this ${type}?`)) return;

  let apiUrl = '';
  if (type === 'amc-type') {
    apiUrl = `/api/amc/amc-types/${id}/`;
  } else if (type === 'payment-terms') {
    apiUrl = `/api/amc/payment-terms/${id}/`;
  }

  fetch(apiUrl, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      loadExistingOptions(type);
      const select = document.getElementById(type.split('-').join('_'));
      const option = select.querySelector(`option[value="${id}"]`);
      if (option) {
        option.remove();
      }
      showMessage('success', `${type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} deleted successfully`);
    } else {
      showMessage('error', data.error);
    }
  });
}

function getCsrfToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  return token ? token.value : '';
}

function showMessage(type, message) {
  alert(message);
}

function handleAMCFormSubmit(event) {
  event.preventDefault();

  const formData = new FormData(event.target);
  const data = Object.fromEntries(formData.entries());

  data.is_generate_contract = data.is_generate_contract === 'on';

  if (!data.customer || !data.start_date || !data.end_date) {
    showMessage('error', 'Please fill in all required fields (Customer, Start Date, End Date)');
    return;
  }

  if (data.is_generate_contract && !data.amc_service_item) {
    showMessage('error', 'Please select an AMC Service Item when generating contract');
    return;
  }

  fetch(submitAMCUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(function(result) {
    if (result.success) {
      showMessage('success', result.message);
      if (result.amc && result.amc.redirect) {
        window.location.href = adminHomeUrlAMC;
      }
    } else {
      showMessage('error', result.error);
    }
  })
  .catch(function(error) {
    console.error('Error:', error);
    showMessage('error', 'An error occurred while saving the AMC');
  });
}

document.getElementById('amcForm').addEventListener('submit', handleAMCFormSubmit);

document.addEventListener('DOMContentLoaded', function() {
  toggleContractFields();

  const customerSelect = document.getElementById('customer');
  if (customerSelect.value) {
    fetchCustomerDetails();
  }
});

// Close modal when clicking outside
document.getElementById('optionModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});
</script>
{% endblock %}