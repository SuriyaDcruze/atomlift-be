{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags %}
{% load static %}

{% block extra_css %}
<style>
/* Modern Tailwind-like styles for Wagtail admin */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

.w-content-wrapper {
  background: #f5f5f5;
  min-height: calc(100vh - 4rem);
  padding: 2rem;
}

.w-modal-overlay {
  position: static;
  inset: auto;
  background-color: transparent;
  display: block;
  padding: 0;
}

.w-modal-content {
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 72rem;
  margin: 2rem auto;
  max-height: none;
  overflow: visible;
  display: flex;
  flex-direction: column;
}

.w-modal-header {
  background: linear-gradient(to right, #2D3A6B, #243158);
  padding: 1.5rem;
  color: white;
}

.w-modal-title {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: white;
}

.w-modal-body {
  padding: 2rem;
  flex: 1;
  overflow-y: auto;
}

.w-form-group {
  margin-bottom: 1.5rem;
}

.w-form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #374151;
  font-size: 0.875rem;
}

.w-form-input {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.w-form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.w-form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  background-color: white;
  cursor: pointer;
}

.w-form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  resize: vertical;
  min-height: 100px;
}

.w-radio-group {
  display: flex;
  gap: 1rem;
  margin-top: 0.5rem;
}

.w-radio-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.w-radio-input {
  margin: 0;
}

.w-radio-label {
  margin: 0;
  font-size: 0.875rem;
  color: #374151;
}

.w-form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.w-form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1rem;
}

.w-error-message {
  color: #dc2626;
  font-size: 0.75rem;
  margin-top: 0.25rem;
  display: none;
}

.w-button-group {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid #e5e7eb;
}

.w-btn {
  padding: 0.75rem 1.5rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease-in-out;
  border: none;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.w-btn-primary {
  background-color: #3b82f6;
  color: white;
}

.w-btn-primary:hover:not(:disabled) {
  background-color: #2563eb;
}

.w-btn-secondary {
  background-color: #6b7280;
  color: white;
}

.w-btn-secondary:hover:not(:disabled) {
  background-color: #4b5563;
}

.w-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Toast notification styles */
.toast-container {
  position: fixed;
  top: 1.25rem;
  right: 1.25rem;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background: white;
  border-radius: 0.375rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  min-width: 20rem;
  max-width: 31.25rem;
  border-left: 4px solid;
  animation: slideInRight 0.3s ease-out;
}

.toast--success {
  border-left-color: #10B981;
}

.toast--error {
  border-left-color: #EF4444;
}

.toast-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
}

.toast-message {
  flex: 1;
  margin-right: 1rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  color: #374151;
}

.toast-close {
  background: none;
  border: none;
  cursor: pointer;
  color: #6B7280;
  padding: 0;
  width: 1.5rem;
  height: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s;
  font-size: 1.25rem;
  line-height: 1;
}

.toast-close:hover {
  color: #374151;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@media (max-width: 640px) {
  .toast {
    min-width: 17.5rem;
    max-width: 90vw;
  }
}

.w-section {
  margin-bottom: 2rem;
}

.w-section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #e5e7eb;
}

.w-required {
  color: #dc2626;
}

/* Customer search dropdown styles */
.w-form-group > div[style*="position: relative"] {
  position: relative;
}

.customer-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #d1d5db;
  border-top: none;
  border-radius: 0 0 0.375rem 0.375rem;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  margin-top: -1px;
}

.customer-item {
  padding: 0.75rem;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  transition: background-color 0.2s;
}

.customer-item:hover {
  background-color: #f9fafb;
}

.customer-item:last-child {
  border-bottom: none;
}

.customer-item-name {
  font-weight: 500;
  color: #374151;
  font-size: 0.875rem;
}

.customer-item-details {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.customer-item.selected {
  background-color: #ebf4ff;
  border-left: 3px solid #3b82f6;
}

.no-results {
  padding: 1rem;
  text-align: center;
  color: #6b7280;
  font-size: 0.875rem;
}

#customerSearch:focus {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

@media (max-width: 768px) {
  .w-form-row,
  .w-form-row-3 {
    grid-template-columns: 1fr;
  }
  
  .w-button-group {
    flex-direction: column;
  }
  
  .w-modal-body {
    padding: 1rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="w-content-wrapper">
  <div class="w-modal-overlay">
    <div class="w-modal-content">
      <div class="w-modal-header">
        <h1 class="w-modal-title">
          {% if is_edit %}Edit Requisition{% else %}Add New Requisition{% endif %}
        </h1>
      </div>
      
      <div class="w-modal-body">
        <form id="requisitionForm" class="w-form">
          {% csrf_token %}
          <!-- Requisition Details Section -->
          <div class="w-section">
            <h2 class="w-section-title">Requisition Details</h2>
            
            <div class="w-form-row">
              <div class="w-form-group">
                <label for="reference_id" class="w-form-label">Reference ID</label>
                <input type="text" id="reference_id" name="reference_id" class="w-form-input" 
                       value="{% if is_edit %}{{ requisition.reference_id }}{% endif %}" readonly>
              </div>
              
              <div class="w-form-group">
                <label for="date" class="w-form-label">Date <span class="w-required">*</span></label>
                <input type="date" id="date" name="date" class="w-form-input" required
                       value="{% if is_edit %}{{ requisition.date|date:'Y-m-d' }}{% endif %}">
                <div id="dateError" class="w-error-message"></div>
              </div>
            </div>
            
            <div class="w-form-row">
              <div class="w-form-group">
                <label for="item" class="w-form-label">Item <span class="w-required">*</span></label>
                <select id="item" name="item" class="w-form-select" required>
                  <option value="">Select an item</option>
                  {% for item in items %}
                    <option value="{{ item.id }}" 
                            {% if is_edit and requisition.item and requisition.item.id == item.id %}selected{% endif %}>
                      {{ item.item_number }} - {{ item.name }}
                    </option>
                  {% endfor %}
                </select>
                <div id="itemError" class="w-error-message"></div>
              </div>
              
              <div class="w-form-group">
                <label for="qty" class="w-form-label">Quantity <span class="w-required">*</span></label>
                <input type="number" id="qty" name="qty" class="w-form-input" min="1" required
                       value="{% if is_edit %}{{ requisition.qty }}{% endif %}">
                <div id="qtyError" class="w-error-message"></div>
              </div>
            </div>
            
            <div class="w-form-row">
              <div class="w-form-group">
                <label for="customerSearch" class="w-form-label">Site/Customer <span class="w-required">*</span></label>
                <div style="position: relative;">
                  <input 
                    type="text" 
                    id="customerSearch" 
                    class="w-form-input" 
                    placeholder="Search customer..."
                    autocomplete="off"
                    value="{% if is_edit and requisition.site %}{{ requisition.site.site_name }}{% endif %}"
                    required
                  />
                  <select id="site" name="site" class="w-form-select" style="display: none;" required>
                    <option value="">Select a site</option>
                    {% for customer in customers %}
                      <option value="{{ customer.id }}" 
                              {% if is_edit and requisition.site and requisition.site.id == customer.id %}selected{% endif %}>
                        {{ customer.site_name }}
                      </option>
                    {% endfor %}
                  </select>
                  <div id="customerDropdown" class="customer-dropdown" style="display: none;">
                    <div id="customerList"></div>
                  </div>
                </div>
                <div id="siteError" class="w-error-message"></div>
              </div>
              
              <div class="w-form-group">
                <label for="amc_id" class="w-form-label">AMC <span class="w-required">*</span></label>
                <select id="amc_id" name="amc_id" class="w-form-select" required>
                  <option value="">Select an AMC</option>
                  {% for amc in amcs %}
                    <option value="{{ amc.id }}" 
                            {% if is_edit and requisition.amc_id and requisition.amc_id.id == amc.id %}selected{% endif %}>
                      {{ amc.amcname }} - {{ amc.customer }}
                    </option>
                  {% endfor %}
                </select>
                <div id="amcError" class="w-error-message"></div>
              </div>
            </div>
            
            <div class="w-form-group">
              <label for="service" class="w-form-label">Service Description</label>
              <textarea id="service" name="service" class="w-form-textarea" 
                        placeholder="Enter service description...">{% if is_edit %}{{ requisition.service }}{% endif %}</textarea>
            </div>
            
            <div class="w-form-group">
              <label for="employee" class="w-form-label">Employee <span class="w-required">*</span></label>
              <select id="employee" name="employee" class="w-form-select" required>
                <option value="">Select an employee</option>
                {% for employee in employees %}
                  <option value="{{ employee.id }}" 
                          {% if is_edit and requisition.employee and requisition.employee.id == employee.id %}selected{% endif %}>
                    {{ employee.username }} - {{ employee.first_name }} {{ employee.last_name }}
                  </option>
                {% endfor %}
              </select>
              <div id="employeeError" class="w-error-message"></div>
            </div>
          </div>
          
          <!-- Status & Approval Section -->
          <div class="w-section">
            <h2 class="w-section-title">Status & Approval</h2>
            
            <div class="w-form-row">
              <div class="w-form-group">
                <label class="w-form-label">Status</label>
                <div class="w-radio-group">
                  <div class="w-radio-item">
                    <input type="radio" id="status_open" name="status" value="OPEN" class="w-radio-input"
                           {% if not is_edit or requisition.status == 'OPEN' %}checked{% endif %}>
                    <label for="status_open" class="w-radio-label">Open</label>
                  </div>
                  <div class="w-radio-item">
                    <input type="radio" id="status_closed" name="status" value="CLOSED" class="w-radio-input"
                           {% if is_edit and requisition.status == 'CLOSED' %}checked{% endif %}>
                    <label for="status_closed" class="w-radio-label">Closed</label>
                  </div>
                </div>
              </div>
              
              <div class="w-form-group">
                <label class="w-form-label">Approval Status</label>
                <div class="w-radio-group">
                  <div class="w-radio-item">
                    <input type="radio" id="approve_pending" name="approve_for" value="PENDING" class="w-radio-input"
                           {% if not is_edit or requisition.approve_for == 'PENDING' %}checked{% endif %}>
                    <label for="approve_pending" class="w-radio-label">Pending</label>
                  </div>
                  <div class="w-radio-item">
                    <input type="radio" id="approve_approved" name="approve_for" value="APPROVED" class="w-radio-input"
                           {% if is_edit and requisition.approve_for == 'APPROVED' %}checked{% endif %}>
                    <label for="approve_approved" class="w-radio-label">Approved</label>
                  </div>
                  <div class="w-radio-item">
                    <input type="radio" id="approve_rejected" name="approve_for" value="REJECTED" class="w-radio-input"
                           {% if is_edit and requisition.approve_for == 'REJECTED' %}checked{% endif %}>
                    <label for="approve_rejected" class="w-radio-label">Rejected</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="w-button-group">
        <button type="button" onclick="handleCancel()" class="w-btn w-btn-secondary">
          Cancel
        </button>
        <button type="button" onclick="handleFormSubmit()" id="submitBtn" class="w-btn w-btn-primary">
          {% if is_edit %}Update Requisition{% else %}Create Requisition{% endif %}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const isEditMode = {{ is_edit|yesno:"true,false" }};
const submitUrl = "{% if is_edit and requisition %}{% url 'edit_requisition_custom' requisition.reference_id %}{% else %}{% url 'add_requisition_custom' %}{% endif %}";
const adminHomeUrl = "/admin/snippets/Requisition/requisition";

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showMessage(type, message) {
  const toast = document.createElement('div');
  toast.className = `toast toast--${type}`;
  toast.innerHTML = `
    <div class="toast-content">
      <div class="toast-message">${message}</div>
      <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
    </div>
  `;

  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container';
    document.querySelector('.w-content-wrapper').appendChild(toastContainer);
  }

  toastContainer.appendChild(toast);

  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, type === 'success' ? 3000 : 5000);
}

function validateForm() {
  const errors = {};
  
  const date = document.getElementById('date').value;
  const qty = parseInt(document.getElementById('qty').value);
  const site = document.getElementById('site').value;
  const item = document.getElementById('item').value;
  const amc_id = document.getElementById('amc_id').value;
  const employee = document.getElementById('employee').value;
  
  if (!date) errors.date = 'Date is required';
  if (!item) errors.item = 'Item is required';
  if (!qty || qty < 1) errors.qty = 'Quantity must be at least 1';
  if (!site) errors.site = 'Customer is required';
  if (!amc_id) errors.amc_id = 'AMC is required';
  if (!employee) errors.employee = 'Employee is required';

  document.getElementById('dateError').textContent = errors.date || '';
  document.getElementById('dateError').style.display = errors.date ? 'block' : 'none';
  document.getElementById('itemError').textContent = errors.item || '';
  document.getElementById('itemError').style.display = errors.item ? 'block' : 'none';
  document.getElementById('qtyError').textContent = errors.qty || '';
  document.getElementById('qtyError').style.display = errors.qty ? 'block' : 'none';
  document.getElementById('siteError').textContent = errors.site || '';
  document.getElementById('siteError').style.display = errors.site ? 'block' : 'none';
  document.getElementById('amcError').textContent = errors.amc_id || '';
  document.getElementById('amcError').style.display = errors.amc_id ? 'block' : 'none';
  document.getElementById('employeeError').textContent = errors.employee || '';
  document.getElementById('employeeError').style.display = errors.employee ? 'block' : 'none';

  return Object.keys(errors).length === 0;
}

function createFormData() {
  const form = document.getElementById('requisitionForm');
  const data = {};
  new FormData(form).forEach((value, key) => {
    if (key === 'qty') value = parseInt(value) || null;
    if (key === 'item' || key === 'site' || key === 'amc_id' || key === 'employee') {
      value = value ? parseInt(value) : null;
    }
    data[key] = value;
  });
  return data;
}

async function handleFormSubmit() {
  if (!validateForm()) return;

  const submitButton = document.getElementById('submitBtn');
  const originalText = submitButton.textContent;
  submitButton.textContent = 'Saving...';
  submitButton.disabled = true;

  try {
    const data = createFormData();
    const response = await fetch(submitUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    });
    const result = await response.json();
    submitButton.textContent = originalText;
    submitButton.disabled = false;

    if (result.success) {
      showMessage('success', result.message || (isEditMode ? 'Requisition updated successfully' : 'Requisition created successfully'));
      setTimeout(() => {
        window.location.href = adminHomeUrl;
      }, 2000);
    } else {
      showMessage('error', result.error || 'Failed to save requisition');
    }
  } catch (error) {
    console.error('Error saving requisition:', error);
    submitButton.textContent = originalText;
    submitButton.disabled = false;
    showMessage('error', 'An error occurred while saving the requisition');
  }
}

function handleCancel() {
  document.getElementById('requisitionForm').reset();
  document.getElementById('dateError').style.display = 'none';
  document.getElementById('itemError').style.display = 'none';
  document.getElementById('qtyError').style.display = 'none';
  document.getElementById('siteError').style.display = 'none';
  document.getElementById('amcError').style.display = 'none';
  document.getElementById('employeeError').style.display = 'none';
  window.history.back();
}

function fetchNextReferenceId() {
  fetch('/requisition/api/requisition/next-reference/')
    .then(response => response.json())
    .then(data => {
      if (data && data.reference_id) {
        document.getElementById('reference_id').value = data.reference_id;
      }
    })
    .catch(error => {
      console.error('Error fetching next reference ID:', error);
      showMessage('error', 'Failed to generate reference ID');
    });
}

// Customer search functionality
let allCustomers = [];
let selectedCustomerId = null;

function loadCustomers() {
  fetch('/requisition/api/requisition/customers/')
    .then(response => response.json())
    .then(data => {
      allCustomers = data;
      const select = document.getElementById('site');
      select.innerHTML = '<option value="">Select a site</option>';
      data.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.site_name;
        select.appendChild(option);
      });
      
      // Auto-select customer if in edit mode
      {% if is_edit and requisition.site %}
      const customerId = {{ requisition.site.id }};
      const customer = allCustomers.find(c => c.id == customerId);
      if (customer) {
        selectCustomer(customer);
      }
      {% endif %}
    })
    .catch(error => {
      console.error('Error loading customers:', error);
      showMessage('error', 'Failed to load customers');
    });
}

function setupCustomerSearch() {
  const searchInput = document.getElementById('customerSearch');
  const dropdown = document.getElementById('customerDropdown');
  
  searchInput.addEventListener('focus', () => {
    if (allCustomers.length > 0) {
      filterCustomers(searchInput.value);
      dropdown.style.display = 'block';
    }
  });
  
  searchInput.addEventListener('input', (e) => {
    filterCustomers(e.target.value);
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.w-form-group')) {
      dropdown.style.display = 'none';
    }
  });
}

function filterCustomers(searchTerm) {
  const dropdown = document.getElementById('customerDropdown');
  
  if (!searchTerm.trim()) {
    displayCustomers(allCustomers);
  } else {
    const term = searchTerm.toLowerCase();
    const filtered = allCustomers.filter(customer => {
      return (
        (customer.site_name && customer.site_name.toLowerCase().includes(term)) ||
        (customer.job_no && customer.job_no.toLowerCase().includes(term)) ||
        (customer.site_id && customer.site_id.toLowerCase().includes(term)) ||
        (customer.reference_id && customer.reference_id.toLowerCase().includes(term)) ||
        (customer.email && customer.email.toLowerCase().includes(term)) ||
        (customer.phone && customer.phone.toLowerCase().includes(term))
      );
    });
    displayCustomers(filtered);
  }
  
  dropdown.style.display = 'block';
}

function displayCustomers(customers) {
  const customerList = document.getElementById('customerList');
  
  if (customers.length === 0) {
    customerList.innerHTML = '<div class="no-results">No customers found</div>';
    return;
  }
  
  customerList.innerHTML = customers.map(customer => `
    <div class="customer-item ${selectedCustomerId === customer.id ? 'selected' : ''}" 
         onclick="selectCustomer(${JSON.stringify(customer).replace(/"/g, '&quot;')})">
      <div class="customer-item-name">${customer.reference_id || ''} ${customer.site_name || 'N/A'}</div>
      <div class="customer-item-details">
        ${customer.job_no ? 'Job No: ' + customer.job_no : ''} 
        ${customer.site_id ? '| Site ID: ' + customer.site_id : ''}
        ${customer.email ? '| ' + customer.email : ''}
      </div>
    </div>
  `).join('');
}

function selectCustomer(customer) {
  selectedCustomerId = customer.id;
  const searchInput = document.getElementById('customerSearch');
  const dropdown = document.getElementById('customerDropdown');
  const hiddenSelect = document.getElementById('site');
  
  searchInput.value = customer.site_name || '';
  hiddenSelect.value = customer.id;
  dropdown.style.display = 'none';
  
  // Clear any error message
  document.getElementById('siteError').style.display = 'none';
}

// Load reference ID on page load if not in edit mode
document.addEventListener('DOMContentLoaded', function() {
  if (!isEditMode) {
    fetchNextReferenceId();
  }
  
  // Load customers and setup search
  loadCustomers();
  setupCustomerSearch();
});
</script>
{% endblock %}
