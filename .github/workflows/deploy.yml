name: Deploy Django to EC2 Runner

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show runner info
        run: |
          echo "Runner: $(uname -a)"
          echo "User: $(id)"
          command -v python3.11 || command -v python3 || true
          node -v || true
          pm2 -v || true
        shell: bash

      - name: Ensure system build deps (may require sudo)
        run: |
          sudo dnf update -y
          sudo dnf install -y gcc gcc-c++ make \
            libffi-devel openssl-devel zlib-devel bzip2-devel xz-devel \
            libjpeg-turbo-devel libpng-devel freetype-devel libwebp-devel \
            lcms2-devel sqlite-devel patch || true
        shell: bash

      - name: Create / activate venv & upgrade pip
        run: |
          PY_BIN=$(command -v python3.11 || command -v python3)
          echo "Using python: $PY_BIN"
          $PY_BIN -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
        shell: bash

      - name: Prepare requirements (convert psycopg2 -> psycopg2-binary if present)
        run: |
          source .venv/bin/activate

          if [ ! -f requirements.txt ]; then
            echo "ERROR: requirements.txt not found in repo root"
            exit 1
          fi

          if grep -qE '^psycopg2([<>=]|$)' requirements.txt; then
            echo "psycopg2 detected in requirements.txt â€” creating tmp_requirements.txt replacing with psycopg2-binary"
            sed -E 's/^psycopg2([<>=].*)?/psycopg2-binary\1/' requirements.txt > tmp_requirements.txt
            echo "REQFILE=tmp_requirements.txt" >> $GITHUB_ENV
          else
            echo "REQFILE=requirements.txt" >> $GITHUB_ENV
          fi

          echo "Using requirements file: $REQFILE"
        shell: bash

      - name: Install Python dependencies into venv
        run: |
          source .venv/bin/activate
          # REQFILE is injected into env via $GITHUB_ENV in the previous step
          echo "Installing from $REQFILE"
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r "$REQFILE"
        shell: bash

      - name: Persist requirements (optional)
        run: |
          source .venv/bin/activate
          python -m pip freeze > requirements.txt
          git status --porcelain || true
        shell: bash

      - name: Write runtime env (.env) from secrets
        run: |
          cat > .env <<EOF
SECRET_KEY=${{ secrets.SECRET_KEY }}
DJANGO_ALLOWED_HOSTS=${{ secrets.DJANGO_ALLOWED_HOSTS }}
DATABASE_NAME=${{ secrets.DB_NAME }}
DATABASE_USER=${{ secrets.DB_USER }}
DATABASE_PASSWORD=${{ secrets.DB_PASSWORD }}
DATABASE_HOST=${{ secrets.DB_HOST }}
DATABASE_PORT=${{ secrets.DB_PORT }}
EOF

          # export for this run
          set -o allexport
          source .env
          set +o allexport

          echo ".env written and exported for this job (not committed)."
        shell: bash

      - name: Run migrations and collectstatic
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}
          DATABASE_NAME: ${{ secrets.DB_NAME }}
          DATABASE_USER: ${{ secrets.DB_USER }}
          DATABASE_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DATABASE_HOST: ${{ secrets.DB_HOST }}
          DATABASE_PORT: ${{ secrets.DB_PORT }}
        run: |
          source .venv/bin/activate
          # export again to ensure subshells have them
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          export DJANGO_ALLOWED_HOSTS="${{ secrets.DJANGO_ALLOWED_HOSTS }}"
          export DATABASE_NAME="${{ secrets.DB_NAME }}"
          export DATABASE_USER="${{ secrets.DB_USER }}"
          export DATABASE_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DATABASE_HOST="${{ secrets.DB_HOST }}"
          export DATABASE_PORT="${{ secrets.DB_PORT }}"

          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
        shell: bash

      - name: Ensure pm2 installed globally (sudo may be required)
        run: |
          if ! command -v pm2 >/dev/null 2>&1; then
            sudo npm install -g pm2
          fi
          pm2 -v
        shell: bash

      - name: Restart Gunicorn via PM2
        run: |
          source .venv/bin/activate
          pm2 delete atom-backend || true

          # Set your WSGI module name below (edit as needed)
          DJANGO_WSGI_MODULE="crm_lift_atom.wsgi"

          pm2 start ".venv/bin/gunicorn" --name atom-backend --interpreter bash -- \
            --bind 127.0.0.1:8000 ${DJANGO_WSGI_MODULE}:application --workers 3

          pm2 save
          pm2 status
        shell: bash

      - name: Health checks & logs
        run: |
          ss -ltnp | grep 8000 || true
          sleep 1
          curl -I --max-time 10 http://127.0.0.1:8000/ || true
          pm2 logs atom-backend --lines 200 || true
        shell: bash
